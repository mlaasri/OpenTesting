/***********************************************************************
**
** This file is part of OpenTesting, an open-source framework for
** designing standardized tests and informal quizzes.
**
** OpenTesting is free software: you can redistribute it and / or
** modify it under the terms of the GNU General Public License as
** published by the Free Software Foundation, either version 3 of the
** License, or (at your option) any later version.
**
** OpenTesting is distributed in the hope that it will be useful, but
** WITHOUT ANY WARRANTY; without even the implied warranty of
** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
** General Public License for more details.
**
** You should have received a copy of the GNU General Public License
** along with OpenTesting. If not, see <https://www.gnu.org/licenses/>.
**
** Copyright(C) 2022, mlaasri
**
***********************************************************************/

#include <memory>
#include <stdexcept>

#include "Instantiator.h"
#include "../../core/questiongenerators/units/BlankUnit.h"
#include "../../core/questiongenerators/units/ExplanationCompletionUnit.h"
#include "../../core/questiongenerators/units/OptionSelectionUnit.h"
#include "../../core/questiongenerators/units/PromptInitializationUnit.h"
#include "../../core/questiongenerators/units/TokenReplacementUnit.h"

/*
* We define a utility macro for expanding variadic arguments. The sole purpose of
* this macro is to solve the divergence of MSVC's preprocessor from the standard on
* how __VA_ARGS__ is handled (MSVC replaces it as one single token).
*/
#define OPENTESTING_INSTANTIATOR_EXPAND(...) __VA_ARGS__

/* We use an X-macro over all supported Unit types */
#define OPENTESTING_INSTANTIATOR_UNIT_TYPE_LOOP(DO, ...) \
    OPENTESTING_INSTANTIATOR_EXPAND(DO(BlankUnit, __VA_ARGS__)) \
    OPENTESTING_INSTANTIATOR_EXPAND(DO(ExplanationCompletionUnit, __VA_ARGS__)) \
    OPENTESTING_INSTANTIATOR_EXPAND(DO(OptionSelectionUnit, __VA_ARGS__)) \
    OPENTESTING_INSTANTIATOR_EXPAND(DO(PromptInitializationUnit, __VA_ARGS__)) \
    OPENTESTING_INSTANTIATOR_EXPAND(DO(TokenReplacementUnit, __VA_ARGS__))

/*
* Based on the list of all supported units, we can automatically retrieve all Unit
* object types with the macros below. The OPENTESTING_INSTANTIATOR_UNIT_TYPE_LOOP
* macro can then be used just like OPENTESTING_INSTANTIATOR_UNIT_TYPE_LOOP to loop
* over all possible object types.
*/
#define OPENTESTING_INSTANTIATOR_UNIT_OBJECT_TYPE_DO(unitType, DO, ...) OPENTESTING_INSTANTIATOR_EXPAND(DO(unitType::ObjectType, __VA_ARGS__))
#define OPENTESTING_INSTANTIATOR_UNIT_OBJECT_TYPE_LOOP(DO, ...) \
    OPENTESTING_INSTANTIATOR_UNIT_TYPE_LOOP(OPENTESTING_INSTANTIATOR_UNIT_OBJECT_TYPE_DO, DO, __VA_ARGS__)

/*
* We define a handy macro for testing if a candidate type matches a supported type
* and for creating a new instance if so.
*/
#define OPENTESTING_INSTANTIATOR_TRY_INSTANTIATE(supportedType, candidateType) if (candidateType == #supportedType) return std::make_unique<supportedType>();

std::unique_ptr<OT::Serializable> OT::Instantiator::instantiateUnit(const std::string& typeName)
{
    /* We try every supported unit type */
    OPENTESTING_INSTANTIATOR_UNIT_TYPE_LOOP(OPENTESTING_INSTANTIATOR_TRY_INSTANTIATE, typeName);

    /*
    * If the type does not correspond to a supported class, we throw an exception.
    */
    throw std::invalid_argument("Unsupported type: Instantiator cannot instantiate an object of type '" + typeName + "'.");
}
